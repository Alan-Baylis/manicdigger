<html>

<head>
<title></title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<script type="text/javascript" src="ManicDigger.js"></script>
<script type="text/javascript" src="Assets.js"></script>

<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;

    varying vec2 vTextureCoord;

    uniform sampler2D uSampler;

    void main(void) {
        gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
    }
</script>

<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;

    varying vec2 vTextureCoord;


    void main(void) {
        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
        vTextureCoord = aTextureCoord;
    }
</script>


<script type="text/javascript">



function PlatformJs()
{
}

PlatformJs.prototype = new GamePlatform();

PlatformJs.prototype.addOnCrash = function(handler) {
}

PlatformJs.prototype.addOnKeyEvent = function(handler) {
}

PlatformJs.prototype.addOnMouseEvent = function(handler) {
}

var newFrameHandler;
PlatformJs.prototype.addOnNewFrame = function(handler) {
	newFrameHandler = handler;
}

PlatformJs.prototype.addOnTouchEvent = function(handler) {
}

PlatformJs.prototype.applicationDoEvents = function() {
}

PlatformJs.prototype.audioLoad = function(data) {
	return null;
}

PlatformJs.prototype.audioPlay = function(sample, x, y, z) {
}

PlatformJs.prototype.audioPlayLoop = function(sample, play, restart) {
}

PlatformJs.prototype.audioUpdateListener = function(posX, posY, posZ, orientX, orientY, orientZ) {
}

PlatformJs.prototype.aviWriterCreate = function() {
	return null;
}

PlatformJs.prototype.bindTexture2d = function(texture) {
}

PlatformJs.prototype.bitmapCreate = function(width, height) {
	return null;
}

PlatformJs.prototype.bitmapCreateFromPng = function(data, dataLength) {
	return null;
}

PlatformJs.prototype.bitmapDelete = function(bmp) {
}

PlatformJs.prototype.bitmapGetHeight = function(bmp) {
	return 0;
}

PlatformJs.prototype.bitmapGetPixelsArgb = function(bitmap, bmpPixels) {
}

PlatformJs.prototype.bitmapGetWidth = function(bmp) {
	return 0;
}

PlatformJs.prototype.bitmapSetPixelsArgb = function(bmp, pixels) {
}

PlatformJs.prototype.byteArrayLength = function(arr) {
	return 0;
}

PlatformJs.prototype.castToDummyNetOutgoingMessage = function(message) {
	return null;
}

PlatformJs.prototype.castToEnetNetConnection = function(connection) {
	return null;
}

PlatformJs.prototype.castToEnetNetOutgoingMessage = function(msg) {
	return null;
}

PlatformJs.prototype.castToPlayerInterpolationState = function(a) {
	return null;
}

PlatformJs.prototype.castToTcpNetOutgoingMessage = function(message) {
	return null;
}

PlatformJs.prototype.changeResolution = function(width, height, bitsPerPixel, refreshRate) {
}

PlatformJs.prototype.charArrayToString = function(charArray, length) {
	return null;
}

PlatformJs.prototype.chatLog = function(servername, p) {
	return false;
}

PlatformJs.prototype.clipboardContainsText = function() {
	return false;
}

PlatformJs.prototype.clipboardGetText = function() {
	return null;
}

PlatformJs.prototype.clipboardSetText = function(s) {
}

PlatformJs.prototype.consoleWriteLine = function(p) {
}

PlatformJs.prototype.createModel = function(modelData) {
	return null;
}

PlatformJs.prototype.createTextTexture = function(t) {
	return null;
}

PlatformJs.prototype.deleteModel = function(model) {
}

PlatformJs.prototype.directoryGetFiles = function(path, length) {
	return null;
}

PlatformJs.prototype.drawModel = function(model) {
}

PlatformJs.prototype.drawModelData = function(data) {
}

PlatformJs.prototype.drawModels = function(model, count) {
}

PlatformJs.prototype.enetAvailable = function() {
	return false;
}

PlatformJs.prototype.enetCreateHost = function() {
	return null;
}

PlatformJs.prototype.enetHostCheckEvents = function(host, event_) {
	return false;
}

PlatformJs.prototype.enetHostConnect = function(host, hostName, port, data, channelLimit) {
	return null;
}

PlatformJs.prototype.enetHostInitialize = function(host, address, peerLimit, channelLimit, incomingBandwidth, outgoingBandwidth) {
}

PlatformJs.prototype.enetHostInitializeServer = function(host, port, peerLimit) {
}

PlatformJs.prototype.enetHostService = function(host, timeout, enetEvent) {
	return false;
}

PlatformJs.prototype.enetPeerSend = function(peer, channelID, data, dataLength, flags) {
}

PlatformJs.prototype.exit = function() {
}

PlatformJs.prototype.exitMousePointerLock = function() {
}

PlatformJs.prototype.fileName = function(fullpath) {
	return null;
}

PlatformJs.prototype.fileOpenDialog = function(extension, extensionName, initialDirectory) {
	return null;
}

PlatformJs.prototype.fileReadAllLines = function(path, length) {
	return null;
}

PlatformJs.prototype.floatModulo = function(a, b) {
	return 0;
}

PlatformJs.prototype.floatParse = function(value) {
	return 0;
}

PlatformJs.prototype.floatToInt = function(value) {
	return 0;
}

PlatformJs.prototype.floatToString = function(value) {
	return null;
}

PlatformJs.prototype.floatTryParse = function(s, ret) {
	return false;
}

PlatformJs.prototype.focused = function() {
	return false;
}

PlatformJs.prototype.gLDeleteTexture = function(id) {
}

PlatformJs.prototype.gLDisableAlphaTest = function() {
}

PlatformJs.prototype.gLEnableAlphaTest = function() {
}

PlatformJs.prototype.gLLineWidth = function(width) {
}

PlatformJs.prototype.getCanvasHeight = function() {
	return 500;
}

PlatformJs.prototype.getCanvasWidth = function() {
	return 500;
}

PlatformJs.prototype.getDisplayResolutionDefault = function() {
	return null;
}

PlatformJs.prototype.getDisplayResolutions = function(resolutionsCount) {
	return null;
}

PlatformJs.prototype.getGameVersion = function() {
	return null;
}

PlatformJs.prototype.getLanguageIso6391 = function() {
	return null;
}

PlatformJs.prototype.getPreferences = function() {
	return null;
}

PlatformJs.prototype.getWindowState = function() {
	return WindowState.MAXIMIZED;
}

PlatformJs.prototype.glClearColorBufferAndDepthBuffer = function() {
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
}

PlatformJs.prototype.glClearColorRgbaf = function(r, g, b, a) {
        gl.clearColor(r, g, b, a);
}

PlatformJs.prototype.glClearDepthBuffer = function() {
}

PlatformJs.prototype.glColorMaterialFrontAndBackAmbientAndDiffuse = function() {
}

PlatformJs.prototype.glCullFaceBack = function() {
}

PlatformJs.prototype.glDepthMask = function(flag) {
}

PlatformJs.prototype.glDisableCullFace = function() {
}

PlatformJs.prototype.glDisableDepthTest = function() {
}

PlatformJs.prototype.glDisableFog = function() {
}

PlatformJs.prototype.glEnableColorMaterial = function() {
}

PlatformJs.prototype.glEnableCullFace = function() {
}

PlatformJs.prototype.glEnableDepthTest = function() {
        gl.enable(gl.DEPTH_TEST);
}

PlatformJs.prototype.glEnableFog = function() {
}

PlatformJs.prototype.glEnableLighting = function() {
}

PlatformJs.prototype.glEnableTexture2d = function() {
}

PlatformJs.prototype.glFogFogColor = function(r, g, b, a) {
}

PlatformJs.prototype.glFogFogDensity = function(density) {
}

PlatformJs.prototype.glFogFogModeExp2 = function() {
}

PlatformJs.prototype.glGetMaxTextureSize = function() {
	return 0;
}

PlatformJs.prototype.glHintFogHintNicest = function() {
}

PlatformJs.prototype.glLightModelAmbient = function(r, g, b) {
}

PlatformJs.prototype.glShadeModelSmooth = function() {
}

PlatformJs.prototype.glViewport = function(x, y, width, height) {
	gl.viewport(x, y, width, height);
}

PlatformJs.prototype.grabScreenshot = function() {
	return null;
}

PlatformJs.prototype.gzipCompress = function(data, dataLength, retLength) {
	return null;
}

PlatformJs.prototype.gzipDecompress = function(compressed, compressedLength, ret) {
}

PlatformJs.prototype.initShaders = function() {
}

PlatformJs.prototype.intParse = function(value) {
	return 0;
}

PlatformJs.prototype.intToString = function(value) {
	return null;
}

PlatformJs.prototype.isCached = function(md5) {
	return false;
}

PlatformJs.prototype.isChecksum = function(checksum) {
	return false;
}

PlatformJs.prototype.isDebuggerAttached = function() {
	return false;
}

PlatformJs.prototype.isFastSystem = function() {
	return false;
}

PlatformJs.prototype.isMousePointerLocked = function() {
	return false;
}

PlatformJs.prototype.isSmallScreen = function() {
	return false;
}

PlatformJs.prototype.isValidTypingChar = function(c) {
	return false;
}

PlatformJs.prototype.keyName = function(key) {
	return null;
}

PlatformJs.prototype.loadAssetFromCache = function(md5) {
	return null;
}

PlatformJs.prototype.loadAssetsAsyc = function(list, progress) {
}

PlatformJs.prototype.loadTextureFromBitmap = function(bmp) {
	return 0;
}

PlatformJs.prototype.mathAcos = function(p) {
	return 0;
}

PlatformJs.prototype.mathCos = function(a) {
	return 0;
}

PlatformJs.prototype.mathSin = function(a) {
	return 0;
}

PlatformJs.prototype.mathSqrt = function(value) {
	return 0;
}

PlatformJs.prototype.mathTan = function(p) {
	return 0;
}

PlatformJs.prototype.messageBoxShowError = function(text, caption) {
}

PlatformJs.prototype.monitorCreate = function() {
	return null;
}

PlatformJs.prototype.monitorEnter = function(monitorObject) {
}

PlatformJs.prototype.monitorExit = function(monitorObject) {
}

PlatformJs.prototype.mouseCursorIsVisible = function() {
	return false;
}

PlatformJs.prototype.mouseCursorSetVisible = function(value) {
}

PlatformJs.prototype.multithreadingAvailable = function() {
	return false;
}

PlatformJs.prototype.openLinkInBrowser = function(url) {
}

PlatformJs.prototype.parseUri = function(uri) {
	return null;
}

PlatformJs.prototype.pathCombine = function(part1, part2) {
	return null;
}

PlatformJs.prototype.pathSavegames = function() {
	return null;
}

PlatformJs.prototype.pathStorage = function() {
	return null;
}

PlatformJs.prototype.queueUserWorkItem = function(action) {
}

PlatformJs.prototype.randomCreate = function() {
	var random = {};
	random.maxNext = function() { return 0; };
	return random;
}

PlatformJs.prototype.readAllLines = function(p, retCount) {
	return null;
}

PlatformJs.prototype.requestMousePointerLock = function() {
}

PlatformJs.prototype.saveAssetToCache = function(tosave) {
}

PlatformJs.prototype.saveScreenshot = function() {
}

PlatformJs.prototype.setMatrixUniformModelView = function(mvMatrix) {
        gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
}

PlatformJs.prototype.setMatrixUniformProjection = function(pMatrix) {
        gl.uniformMatrix4fv(shaderProgram.pMatrixUniform, false, pMatrix);
}

PlatformJs.prototype.setPreferences = function(preferences) {
}

PlatformJs.prototype.setTextRendererFont = function(fontID) {
}

PlatformJs.prototype.setTitle = function(applicationname) {
}

PlatformJs.prototype.setVSync = function(enabled) {
}

PlatformJs.prototype.setWindowState = function(value) {
}

PlatformJs.prototype.showKeyboard = function(show) {
}

PlatformJs.prototype.singlePlayerServerAvailable = function() {
	return false;
}

PlatformJs.prototype.singlePlayerServerDisable = function() {
}

PlatformJs.prototype.singlePlayerServerExit = function() {
}

PlatformJs.prototype.singlePlayerServerGetNetwork = function() {
	return null;
}

PlatformJs.prototype.singlePlayerServerLoaded = function() {
	return false;
}

PlatformJs.prototype.singlePlayerServerStart = function(saveFilename) {
}

PlatformJs.prototype.stringContains = function(a, b) {
	return false;
}

PlatformJs.prototype.stringEmpty = function(data) {
	return false;
}

PlatformJs.prototype.stringFormat = function(format, arg0) {
	return null;
}

PlatformJs.prototype.stringFormat2 = function(format, arg0, arg1) {
	return null;
}

PlatformJs.prototype.stringFormat3 = function(format, arg0, arg1, arg2) {
	return null;
}

PlatformJs.prototype.stringFormat4 = function(format, arg0, arg1, arg2, arg3) {
	return null;
}

PlatformJs.prototype.stringFromUtf8ByteArray = function(value, valueLength) {
	return null;
}

PlatformJs.prototype.stringIndexOf = function(s, p) {
	return 0;
}

PlatformJs.prototype.stringReplace = function(s, from, to) {
	return null;
}

PlatformJs.prototype.stringSplit = function(value, separator, returnLength) {
	return null;
}

PlatformJs.prototype.stringStartsWithIgnoreCase = function(a, b) {
	return false;
}

PlatformJs.prototype.stringToCharArray = function(s, length) {
	return null;
}

PlatformJs.prototype.stringToLower = function(p) {
	return null;
}

PlatformJs.prototype.stringToUtf8ByteArray = function(s, retLength) {
	return null;
}

PlatformJs.prototype.stringTrim = function(value) {
	return null;
}

PlatformJs.prototype.tcpAvailable = function() {
	return false;
}

PlatformJs.prototype.tcpConnect = function(ip, port, connected) {
}

PlatformJs.prototype.tcpReceive = function(data, dataLength) {
	return 0;
}

PlatformJs.prototype.tcpSend = function(data, length) {
}

PlatformJs.prototype.textSize = function(text, fontSize, outWidth, outHeight) {
}

PlatformJs.prototype.threadSpinWait = function(iterations) {
}

PlatformJs.prototype.throwException = function(message) {
}

PlatformJs.prototype.thumbnailDownloadAsync = function(ip, port, response) {
}

PlatformJs.prototype.timeMillisecondsFromStart = function() {
	return 0;
}

PlatformJs.prototype.timestamp = function() {
	return null;
}

PlatformJs.prototype.webClientDownloadDataAsync = function(url, response) {
}

PlatformJs.prototype.webClientUploadDataAsync = function(url, data, dataLength, response) {
}

PlatformJs.prototype.windowExit = function() {
}


PlatformJs.prototype.start = function() {
}




/**
 * Provides requestAnimationFrame in a cross browser way.
 */
window.requestAnimFrame = (function() {
  return window.requestAnimationFrame ||
         window.webkitRequestAnimationFrame ||
         window.mozRequestAnimationFrame ||
         window.oRequestAnimationFrame ||
         window.msRequestAnimationFrame ||
         function(/* function FrameRequestCallback */ callback, /* DOMElement Element */ element) {
           window.setTimeout(callback, 1000/60);
         };
})();

    var gl;

    function initGL(canvas) {
        try {
            gl = canvas.getContext("experimental-webgl");
            gl.viewportWidth = canvas.width;
            gl.viewportHeight = canvas.height;
        } catch (e) {
        }
        if (!gl) {
            alert("Could not initialise WebGL, sorry :-(");
        }
    }


    function getShader(gl, id) {
        var shaderScript = document.getElementById(id);
        if (!shaderScript) {
            return null;
        }

        var str = "";
        var k = shaderScript.firstChild;
        while (k) {
            if (k.nodeType == 3) {
                str += k.textContent;
            }
            k = k.nextSibling;
        }

        var shader;
        if (shaderScript.type == "x-shader/x-fragment") {
            shader = gl.createShader(gl.FRAGMENT_SHADER);
        } else if (shaderScript.type == "x-shader/x-vertex") {
            shader = gl.createShader(gl.VERTEX_SHADER);
        } else {
            return null;
        }

        gl.shaderSource(shader, str);
        gl.compileShader(shader);

        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
            alert(gl.getShaderInfoLog(shader));
            return null;
        }

        return shader;
    }


    var shaderProgram;

    function initShaders() {
        var fragmentShader = getShader(gl, "shader-fs");
        var vertexShader = getShader(gl, "shader-vs");

        shaderProgram = gl.createProgram();
        gl.attachShader(shaderProgram, vertexShader);
        gl.attachShader(shaderProgram, fragmentShader);
        gl.linkProgram(shaderProgram);

        if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
            alert("Could not initialise shaders");
        }

        gl.useProgram(shaderProgram);

        shaderProgram.vertexPositionAttribute = gl.getAttribLocation(shaderProgram, "aVertexPosition");
        gl.enableVertexAttribArray(shaderProgram.vertexPositionAttribute);

        shaderProgram.textureCoordAttribute = gl.getAttribLocation(shaderProgram, "aTextureCoord");
        gl.enableVertexAttribArray(shaderProgram.textureCoordAttribute);

        shaderProgram.pMatrixUniform = gl.getUniformLocation(shaderProgram, "uPMatrix");
        shaderProgram.mvMatrixUniform = gl.getUniformLocation(shaderProgram, "uMVMatrix");
        shaderProgram.samplerUniform = gl.getUniformLocation(shaderProgram, "uSampler");
    }


    function handleLoadedTexture(textures) {
        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);

        gl.bindTexture(gl.TEXTURE_2D, textures[0]);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, textures[0].image);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);

        gl.bindTexture(gl.TEXTURE_2D, textures[1]);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, textures[1].image);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);

        gl.bindTexture(gl.TEXTURE_2D, textures[2]);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, textures[2].image);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_NEAREST);
        gl.generateMipmap(gl.TEXTURE_2D);

        gl.bindTexture(gl.TEXTURE_2D, null);
    }


    var crateTextures = Array();

    function initTexture() {
        var crateImage = new Image();

        for (var i=0; i < 3; i++) {
            var texture = gl.createTexture();
            texture.image = crateImage;
            crateTextures.push(texture);
        }

        crateImage.onload = function () {
            handleLoadedTexture(crateTextures)
        }
        crateImage.src = "crate.gif";
    }


    function degToRad(degrees) {
        return degrees * Math.PI / 180;
    }


    var currentlyPressedKeys = {};

    function handleKeyDown(event) {
        currentlyPressedKeys[event.keyCode] = true;

        if (String.fromCharCode(event.keyCode) == "F") {
            filter += 1;
            if (filter == 3) {
                filter = 0;
            }
        }
    }


    function handleKeyUp(event) {
        currentlyPressedKeys[event.keyCode] = false;
    }


var lastTime = 0;
var newFrameArgs = {};
newFrameArgs.dt = 0;
newFrameArgs.getDt = function() { return this.dt; }
newFrameArgs.setDt = function(dt_) { this.dt = dt_; }

    function tick() {
	  requestAnimFrame(tick);
        var timeNow = new Date().getTime();
        if (lastTime != 0) {
		var elapsed = timeNow - lastTime;
		newFrameArgs.dt = elapsed / 1000;
	  }
	  lastTime = timeNow;
        newFrameHandler.onNewFrame(newFrameArgs);
    }

    function webGLStart() {
        var canvas = document.getElementById("lesson06-canvas");
        initGL(canvas);
        initShaders();
        initTexture();

        gl.clearColor(1.0, 0.0, 0.0, 1.0);
        gl.enable(gl.DEPTH_TEST);

        document.onkeydown = handleKeyDown;
        document.onkeyup = handleKeyUp;
        
        var mainmenu = new MainMenu();
        var platform = new PlatformJs();
        mainmenu.start(platform);
        platform.start();
        tick();
    }

</script>


</head>


<body onload="webGLStart();">
    <canvas id="lesson06-canvas" style="border: none;" width="500" height="500"></canvas>
</body>

</html>
